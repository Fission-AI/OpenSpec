# 实现任务

## 1. 更新约定
- [x] 1.1 使用基于增量的方法更新 openspec-conventions 规范
- [x] 1.2 添加基于标题的要求识别
- [x] 1.3 定义 ADDED/MODIFIED/REMOVED/RENAMED 部分
- [x] 1.4 记录标准输出符号 (+ ~ - →)
- [x] 1.5 使用基于增量的约定更新 openspec/README.md
- [x] 1.6 更新示例以使用增量格式

## 2. 更新差异命令
- [ ] 2.1 使用要求级别比较更新 cli-diff 规范
- [ ] 2.2 将规范解析为要求级别结构
- [ ] 2.3 应用增量生成未来状态
- [ ] 2.4 实现并排比较视图（仅变更）
- [ ] 2.5 为要求级别比较添加测试
- [ ] 2.6 为并排视图格式添加测试

## 3. 更新归档命令
- [x] 3.1 使用增量处理行为更新 cli-archive 规范
- [x] 3.2 实现要求块提取器，保留确切标题（`### Requirement: [Name]`）并捕获完整内容（包括场景）
- [x] 3.3 实现标准化标题匹配（仅修剪，区分大小写）
- [x] 3.4 解析增量部分（ADDED/MODIFIED/REMOVED/RENAMED）
- [x] 3.5 目标规范不存在时创建新规范
  - [x] 3.5.1 自动生成最小骨架：`# [Spec Name] Specification`、`## Purpose` 占位符、`## Requirements`
  - [x] 3.5.2 仅允许对不存在的规范进行 ADDED 操作；如果存在 MODIFIED/REMOVED/RENAMED 则中止
- [x] 3.6 按顺序应用变更：RENAMED → REMOVED → MODIFIED → ADDED
- [x] 3.7 验证和冲突检查
  - [x] 3.7.1 MODIFIED/REMOVED 要求存在（应用重命名映射后）
  - [x] 3.7.2 ADDED 要求尚不存在（考虑重命名后状态）
  - [x] 3.7.3 RENAMED FROM 标题存在；TO 标题不存在（包括与 ADDED 的冲突）
  - [x] 3.7.4 所有操作后规范内无重复标题
  - [x] 3.7.5 检测跨部分冲突（例如，同一要求在 MODIFIED 和 REMOVED 中）
  - [x] 3.7.6 存在重命名时，要求 MODIFIED 引用新标题
- [x] 3.8 原子更新
  - [x] 3.8.1 首先验证所有增量；在内存中为每个规范暂存更新
  - [x] 3.8.2 每个规范单次写入；任何验证失败时中止整个归档（无部分写入）
- [x] 3.9 输出和错误消息
  - [x] 3.9.1 显示每个规范的操作计数与符号：`+` 添加、`~` 修改、`-` 删除、`→` 重命名
  - [x] 3.9.2 可选择显示所有规范的聚合总计行
  - [x] 3.9.3 标准化错误消息格式：`[spec] [operation] failed for header "### Requirement: X" — reason`；失败时以 `Aborted. No files were changed.` 结束
- [x] 3.10 幂等性行为（v1）：前置条件失败时中止（例如，ADDED 已存在）；不实现无操作检测
- [x] 3.11 测试
  - [x] 3.11.1 标题标准化（仅修剪）匹配
  - [x] 3.11.2 按正确顺序应用（RENAMED → REMOVED → MODIFIED → ADDED）
  - [x] 3.11.3 验证边缘情况（缺失标题、重复、重命名冲突、冲突部分）
  - [x] 3.11.4 重命名 + 修改交互（MODIFIED 使用新标题）
  - [x] 3.11.5 通过骨架创建新规范
  - [x] 3.11.6 多规范混合操作与独立验证和写入

## 注释
- 归档命令是关键路径 - 必须可靠工作
- 所有新变更必须使用增量格式
- 标题标准化：normalize(header) = trim(header)
- 差异命令仅在并排比较中显示变更的要求