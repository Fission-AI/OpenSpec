# 为规范采用基于增量的变更

## 为什么

当前在变更提案中存储完整未来状态的方法创造了糟糕的审查体验。在 GitHub 上审查变更时，审阅者看到整个规范文件（通常 100 多行）显示为绿色"添加"，无法识别实际变更的内容。随着最近结构化格式的采用，我们现在有了清晰的部分边界，可以采用更好的方法：仅存储添加和修改。

## 变更内容

仅存储实际变更的要求，而不是完整的未来状态：

- **ADDED Requirements**：引入的新功能
- **MODIFIED Requirements**：正在变更的现有要求（必须匹配当前标题）
- **REMOVED Requirements**：已弃用的功能
- **RENAMED Requirements**：显式标题变更（例如，`FROM: Old Name` → `TO: New Name`）

归档命令将使用标准化标题匹配（修剪前导/尾随空白）程序化地应用这些增量，而不是手动复制整个文件。

## 影响

**受影响的规范**：openspec-conventions、cli-archive、cli-diff

**好处**：
- GitHub 差异仅显示实际变更（25 行而不是 150 多行）
- 审阅者立即看到添加、修改或删除的内容
- 当两个变更修改相同要求时，冲突更加明显
- 归档命令可以程序化地应用变更

**格式**：仅增量格式 - 所有变更必须使用 ADDED/MODIFIED/REMOVED 部分。

## 示例

而不是存储 150 行的完整未来规范，仅存储：

```markdown
# 用户认证 - 变更

## ADDED Requirements

### Requirement: OAuth 支持
用户应通过 OAuth 提供商进行认证，包括 Google 和 GitHub。

#### Scenario: OAuth 登录流程
- **当** 用户选择 OAuth 提供商时
- **则** 重定向到提供商授权
- **并且** 交换授权码获取令牌

## MODIFIED Requirements

### Requirement: 会话管理
会话应在 30 分钟无活动后过期。

#### Scenario: 非活动会话超时  
- **当** 30 分钟无活动时 ←（原为 60 分钟）
- **则** 使会话令牌无效
- **并且** 要求重新认证

## RENAMED Requirements
- FROM: `### Requirement: 基本认证`
- TO: `### Requirement: 邮箱认证`
```

这使审查更加专注，变更更加明确。

## 冲突解决

当两个变更修改相同的要求标题时，Git 自然会检测到冲突。这实际上比全状态存储更好，因为 Git 可能会静默合并不兼容的变更。

## 决策和产品指南

为了保持归档流程的精简和可预测，以下决策适用：

- 新规范创建：当目标规范不存在时，自动生成最小骨架并仅插入 ADDED 要求。骨架格式：
  - `# [Spec Name] Specification`
  - `## Purpose` 带占位符："TBD — 由归档变更 [change-name] 创建。归档后更新 Purpose。"
  - `## Requirements`
  - 如果不存在的规范包含 MODIFIED/REMOVED/RENAMED，则中止并指导首先通过仅 ADDED 创建。

- 要求识别：通过确切标题 `### Requirement: [Name]` 匹配要求，使用仅修剪标准化和区分大小写的比较。使用要求块提取器，保留确切标题并捕获主规范和增量文件的完整内容（包括场景）。

- 应用顺序和原子性：按顺序 RENAMED → REMOVED → MODIFIED → ADDED 应用增量。首先验证所有操作，在内存中应用，并一次写入每个规范。任何验证失败时，不写入部分结果而中止。在所有规范上显示聚合总计行：`总计: + A, ~ M, - R, → N`。

- 验证矩阵：强制 MODIFIED/REMOVED 存在；ADDED 不存在；RENAMED FROM 存在且 TO 不存在；所有操作后无重复；且无跨部分冲突（例如，同一项目在 MODIFIED 和 REMOVED 中）。当重命名和修改应用于同一项目时，MODIFIED 必须引用新标题。

- 幂等性：保持 v1 简单。前置条件失败时（例如，ADDED 已存在）中止并显示清晰错误。v1 中不实现无操作检测。

- 输出和用户体验：对于每个规范，使用标准符号 `+ ~ - →` 显示操作计数。可选择在末尾包含简短的聚合总计行。保持消息简洁且可操作。

- 错误消息：将消息标准化为 `[spec] [operation] failed for header "### Requirement: X" — reason`。中止时，明确声明：`已中止。未更改任何文件。`
- 子部分：要求下的任何子部分（例如，`#### Scenario: ...`）在解析和应用期间按原样保留。

- 向后兼容性：拒绝现有规范的完整未来状态规范副本，并指导转换为增量。允许通过仅 ADDED 增量使用上述骨架创建全新规范。

- 试运行：为保持范围最小，v1 中推迟。