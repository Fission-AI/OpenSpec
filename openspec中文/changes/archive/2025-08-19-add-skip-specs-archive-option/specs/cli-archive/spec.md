# CLI 归档命令规范

## 目的
归档命令按照 OpenSpec 约定将已完成的变更从活跃变更目录移动到归档文件夹，并使用基于日期的命名。

## 命令语法
```bash
openspec archive [change-name] [--yes|-y] [--skip-specs]
```

选项：
- `--yes`, `-y`: 跳过确认提示（用于自动化）
- `--skip-specs`: 完全跳过规范更新操作（用于不修改规范的变更）

## 行为

### 要求：变更选择

命令应支持交互式和直接变更选择方法。

#### 场景：交互式选择

- **当** 未提供变更名称时
- **则** 显示可用变更的交互列表（排除 archive/）
- **并且** 允许用户选择一个

#### 场景：直接选择

- **当** 提供变更名称时
- **则** 直接使用该变更
- **并且** 验证其存在

### 要求：任务完成检查

命令应在归档前验证任务完成状态，以防止过早归档。

#### 场景：发现未完成任务

- **当** 发现未完成任务时（标记为 `- [ ]`）
- **则** 向用户显示所有未完成任务
- **并且** 提示确认继续
- **并且** 默认为"否"以确保安全

#### 场景：所有任务完成

- **当** 所有任务完成或不存在 tasks.md 时
- **则** 继续归档而不提示

### 要求：归档过程

归档操作应遵循结构化过程，以安全地将变更移动到归档。

#### 场景：执行归档

- **当** 归档变更时
- **则** 执行以下步骤：
  1. 如果不存在则创建 archive/ 目录
  2. 使用当前日期生成目标名称 `YYYY-MM-DD-[change-name]`
  3. 检查目标目录是否已存在
  4. 除非提供 `--skip-specs`，否则从变更的未来状态规范更新主规范（见下面的规范更新过程）
  5. 将整个变更目录移动到归档位置

#### 场景：归档已存在

- **当** 目标归档已存在时
- **则** 失败并显示错误消息
- **并且** 不覆盖现有归档

#### 场景：成功归档

- **当** 移动成功时
- **则** 显示成功消息，包含归档名称和更新的规范列表（如果有）

### 要求：规范更新过程

在将变更移动到归档之前，命令应更新主规范以反映部署的现实，除非提供了 `--skip-specs` 标志。

#### 场景：跳过规范更新

- **当** 提供 `--skip-specs` 标志时
- **则** 跳过所有规范发现和更新操作
- **并且** 直接继续将变更移动到归档
- **并且** 显示指示规范被跳过的消息

#### 场景：从变更更新规范

- **当** 变更在 `changes/[name]/specs/` 中包含规范且未提供 `--skip-specs` 时
- **则** 执行以下步骤：
  1. 通过与现有规范比较分析哪些规范将受到影响
  2. 向用户显示规范更新摘要（见下面的确认行为）
  3. 除非提供 `--yes` 标志，否则提示确认
  4. 如果确认，对于变更目录中的每个功能规范：
     - 从 `changes/[name]/specs/[capability]/spec.md` 复制规范到 `openspec/specs/[capability]/spec.md`
     - 如果不存在则创建目标目录结构
     - 覆盖现有规范文件（规范代表当前现实，变更规范是新现实）
     - 跟踪更新的规范以用于成功消息

#### 场景：变更中无规范

- **当** 变更中不存在规范且未提供 `--skip-specs` 时
- **则** 跳过规范更新步骤
- **并且** 继续归档

### 要求：确认行为

规范更新确认应在应用变更前提供清晰的可见性。

#### 场景：显示确认

- **当** 提示确认且未提供 `--skip-specs` 时
- **则** 显示清晰摘要，显示：
  - 将创建的规范（新功能）
  - 将更新的规范（现有功能）
  - 每个规范的源路径
- **并且** 格式化确认提示为：
  ```
  以下规范将被更新：
  
  将创建的新规范：
    - cli-archive (来自 changes/add-archive-command/specs/cli-archive/spec.md)
  
  将更新的现有规范：
    - cli-init (来自 changes/update-init-command/specs/cli-init/spec.md)
  
  更新 2 个规范并归档 'add-archive-command'？[y/N]:
  ```

#### 场景：处理确认响应

- **当** 等待用户确认时
- **则** 默认为"否"以确保安全（需要明确的"y"或"yes"）
- **并且** 当提供 `--yes` 或 `-y` 标志时跳过确认
- **并且** 当提供 `--skip-specs` 标志时跳过整个规范确认

#### 场景：用户拒绝规范更新确认

- **当** 用户拒绝规范更新确认时
- **则** 跳过规范更新操作
- **并且** 显示消息："Skipping spec updates. Proceeding with archive."
- **并且** 继续归档操作
- **并且** 显示成功消息，指示规范未更新

## 错误处理

### 要求：错误条件

命令应优雅地处理各种错误条件。

#### 场景：处理错误

- **当** 发生错误时
- **则** 处理以下条件：
  - 缺少 openspec/changes/ 目录
  - 未找到变更
  - 归档目标已存在
  - 文件系统权限问题

## 为什么采用这些决策

**交互选择**：减少输入并帮助用户查看可用变更
**任务检查**：防止意外归档未完成的工作
**日期前缀**：保持时间顺序并防止命名冲突
**无覆盖**：保留历史归档并防止数据丢失
**归档前规范更新**：主目录中的规范代表当前现实；当变更部署并归档时，其未来状态规范成为新现实，必须替换主规范
**规范更新确认**：提供将变更内容的可见性，防止意外覆盖，并确保用户在修改规范前了解影响
**非阻塞确认**：拒绝规范更新不会取消归档 - 用户可以单独审查规范并选择更新它们
**用于自动化的 --yes 标志**：允许 CI/CD 管道在无交互提示的情况下归档，同时默认情况下为手动使用保持安全性
**--skip-specs 标志**：启用归档不修改规范的变更（如基础设施、工具或文档变更），而无需不必要的规范更新提示或操作

## 新增要求

### 要求：跳过规范选项

归档命令应支持 `--skip-specs` 标志，该标志跳过所有规范更新操作并直接进行归档。

#### 场景：使用标志跳过规范更新

- **当** 执行 `openspec archive <change> --skip-specs`
- **则** 跳过规范发现和更新确认
- **并且** 直接继续将变更移动到归档
- **并且** 显示指示规范被跳过的消息

### 要求：非阻塞确认

当用户拒绝规范更新时，归档操作应继续进行而不是取消整个操作。

#### 场景：用户拒绝规范更新确认

- **当** 用户拒绝规范更新确认时
- **则** 跳过规范更新
- **并且** 继续归档操作
- **并且** 显示成功消息，指示规范未更新