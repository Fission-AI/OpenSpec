# 设计：Zod 验证框架

## 架构决策

### 验证级别
三级验证系统：
1. **ERROR**：阻止解析的结构问题（必须修复）
2. **WARNING**：应解决的质量问题（建议修复）
3. **INFO**：改进建议（可选）

**理由：** 
- 渐进式执行允许团队逐步采用验证
- CI/CD 可以在错误时失败但初始允许警告
- 信息级别提供指导而不阻塞

### 验证规则层次

#### 规范验证规则
```
ERROR 级别：
- 缺少 ## Overview 或 ## Requirements 部分
- 无效的标题层次结构
- 格式错误的要求/场景结构

WARNING 级别：
- 无场景的要求
- 缺少 SHALL 关键字的要求
- 空的概述部分

INFO 级别：
- 非常长的要求文本（>500 字符）
- 无 Given/When/Then 结构的场景
```

#### 变更验证规则
```
ERROR 级别：
- 缺少 ## Why 或 ## What Changes 部分
- 无效的增量操作类型
- 格式错误的增量结构

WARNING 级别：
- Why 部分太简短（<50 字符）
- 无明确描述的增量
- ADDED/MODIFIED 中缺少要求

INFO 级别：
- 非常长的 why 部分（>1000 字符）
- 单个变更中增量过多（>10）
```

### 严格模式
- **默认**：显示所有级别，仅在 ERROR 时失败
- **--strict 标志**：在 ERROR 和 WARNING 时都失败
- **用例**：CI/CD 管道中的渐进式质量改进

### 归档命令安全性
**问题：** 无效规范可能被归档，污染归档。

**解决方案：** 
1. 归档前验证（默认行为）
2. --no-validate 标志带保护措施：
   - 交互式确认提示
   - 突出警告消息
   - 带时间戳的控制台日志
   - 不推荐用于 CI/CD 使用

**理由：**
- 默认保护归档完整性
- 允许带责任的紧急覆盖
- 验证绕过的清晰审计轨迹

### 验证报告格式
```json
{
  "valid": boolean,
  "issues": [
    {
      "level": "ERROR" | "WARNING" | "INFO",
      "path": "requirements[0].scenarios",
      "message": "要求必须至少有一个场景",
      "line": 15,
      "column": 0
    }
  ],
  "summary": {
    "errors": 2,
    "warnings": 5,
    "info": 3
  }
}
```

**好处：**
- 机器可读用于工具集成
- 人类友好的消息
- 行/列信息用于 IDE 集成
- 摘要用于快速评估

### 实现策略
1. **带细化的 Zod 模式**：类型定义中的内置验证
2. **自定义验证器**：额外的业务逻辑验证
3. **可组合规则**：不同上下文的混合匹配
4. **可扩展框架**：无需重构即可轻松添加新规则