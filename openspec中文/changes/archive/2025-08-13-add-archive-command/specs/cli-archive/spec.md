# CLI 归档命令规范

## 目的
归档命令按照 OpenSpec 约定将已完成的变更从活跃变更目录移动到归档文件夹，并使用基于日期的命名。

## 命令语法
```bash
openspec archive [change-name] [--yes|-y]
```

选项：
- `--yes`, `-y`: 跳过确认提示（用于自动化）

## 行为

### 变更选择
当未提供变更名称时
则显示可用变更的交互列表（排除 archive/）
并允许用户选择一个

当提供变更名称时
则直接使用该变更
并验证其存在

### 任务完成检查
命令应扫描变更的 tasks.md 文件以查找未完成的任务（标记为 `- [ ]`）

当发现未完成的任务时
则向用户显示所有未完成的任务
并提示确认继续
并默认为"否"以确保安全

当所有任务都完成或不存在 tasks.md 时
则继续归档而不提示

### 归档过程
归档操作应：
1. 如果不存在则创建 archive/ 目录
2. 使用当前日期生成目标名称 `YYYY-MM-DD-[change-name]`
3. 检查目标目录是否已存在
4. 从变更的未来状态规范更新主规范（见下面的规范更新过程）
5. 将整个变更目录移动到归档位置

当目标归档已存在时
则失败并显示错误消息
且不覆盖现有归档

当移动成功时
则显示成功消息，包含归档名称和更新的规范列表

### 规范更新过程
在将变更移动到归档之前，命令应更新主规范以反映部署的现实：

当变更在 `changes/[name]/specs/` 中包含规范时
则：
1. 通过与现有规范比较分析哪些规范将受到影响
2. 向用户显示规范更新摘要（见下面的确认行为）
3. 除非提供 `--yes` 标志，否则提示确认
4. 如果确认，对于变更目录中的每个功能规范：
   - 从 `changes/[name]/specs/[capability]/spec.md` 复制规范到 `openspec/specs/[capability]/spec.md`
   - 如果不存在则创建目标目录结构
   - 覆盖现有规范文件（规范代表当前现实，变更规范是新现实）
   - 跟踪更新的规范以用于成功消息

当变更中不存在规范时
则跳过规范更新步骤
并继续归档

### 确认行为
规范更新确认应：
- 显示清晰摘要，显示：
  - 将创建的规范（新功能）
  - 将更新的规范（现有功能）
  - 每个规范的源路径
- 格式化确认提示为：
  ```
  以下规范将被更新：
  
  将创建的新规范：
    - cli-archive (来自 changes/add-archive-command/specs/cli-archive/spec.md)
  
  将更新的现有规范：
    - cli-init (来自 changes/update-init-command/specs/cli-init/spec.md)
  
  更新 2 个规范并归档 'add-archive-command'？[y/N]:
  ```
- 默认为"否"以确保安全（需要明确的"y"或"yes"）
- 当提供 `--yes` 或 `-y` 标志时跳过确认

当用户拒绝确认时
则中止整个归档操作
并显示消息："Archive cancelled. No changes were made."
并以非零状态码退出

## 错误处理

应处理以下错误条件：
- 缺少 openspec/changes/ 目录
- 未找到变更
- 归档目标已存在
- 文件系统权限问题

## 为什么采用这些决策

**交互选择**：减少输入并帮助用户查看可用变更
**任务检查**：防止意外归档未完成的工作
**日期前缀**：保持时间顺序并防止命名冲突
**无覆盖**：保留历史归档并防止数据丢失
**归档前规范更新**：主目录中的规范代表当前现实；当变更部署并归档时，其未来状态规范成为新现实，必须替换主规范
**规范更新确认**：提供将变更内容的可见性，防止意外覆盖，并确保用户在修改规范前了解影响
**用于自动化的 --yes 标志**：允许 CI/CD 管道在无交互提示的情况下归档，同时默认情况下为手动使用保持安全性