name: Polish Release Notes

# Uses Claude to transform raw changelog into polished release notes.
# Triggered automatically by release-prepare after publishing, or manually.
on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release tag to polish (e.g., v0.18.0)'
        required: true
        type: string

env:
  TAG_NAME: ${{ inputs.tag_name }}

permissions:
  contents: write

jobs:
  polish:
    # Only run on the main repo, not forks
    if: github.repository == 'augmenter-dev/lightspec'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check Claude auth availability
        id: auth-check
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ -n "${CLAUDE_CODE_OAUTH_TOKEN}" ] || [ -n "${ANTHROPIC_API_KEY}" ]; then
            echo "has_auth=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_auth=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Get current release body
        id: get-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release view "${{ env.TAG_NAME }}" --json body -q '.body' > current-notes.md
          echo "Fetched release notes for ${{ env.TAG_NAME }}"

      - name: Transform release notes with Claude
        if: ${{ steps.auth-check.outputs.has_auth == 'true' }}
        uses: anthropics/claude-code-action@v1
        id: claude
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: "--allowedTools Write,Read"
          prompt: |
            Transform the changelog in `current-notes.md` into release notes for LightSpec ${{ env.TAG_NAME }}.

            ## Voice

            LightSpec is a developer tool. Write like you're talking to a peer:
            - Direct and practical, not marketing copy
            - Focus on what changed and why it matters
            - Skip the hype, keep it real

            ## Output

            Create two files:

            ### 1. `release-title.txt`

            A short title in this format:
            ```
            ${{ env.TAG_NAME }} - [1-4 words describing the release]
            ```

            Examples:
            - `v0.23.0 - Enhanced Change Management`
            - `v0.16.0 - Antigravity, iFlow Support`
            - `v0.15.0 - Gemini CLI, RooCode`

            Rules for title:
            - Lead with the most notable addition
            - 1-4 words after the dash, no fluff
            - If multiple features, comma-separate the top 2
            - For bugfix-only releases, use something like `v0.17.2 - Pre-commit Hook Fix`

            ### 2. `polished-notes.md`

            ```markdown
            ## What's New in ${{ env.TAG_NAME }}

            [One sentence: what's the theme of this release?]

            ### New

            - **Feature name** - What it does and why you'd use it

            ### Improved

            - **Area** - What got better

            ### Fixed

            - What was broken, now works
            ```

            Omit empty sections.

            ## Rules

            1. Write for developers using LightSpec with AI coding assistants
            2. Remove commit hashes (like `eb152eb:`), PR numbers, and changesets wrappers (`### Minor Changes`)
            3. Lead with what users can do, not implementation details
            4. One to two sentences per item, max
            5. Use **bold** for feature/area names
            6. Skip internal changes (CI, refactors, tests) unless they affect users
            7. If the input is already well-formatted, just clean up structure and remove noise

            ## Example

            Before:
            ```
            ### Minor Changes
            - 8dfd824: Add support for archiving completed changes with metadata preservation
              **New Commands:**
              - `lightspec archive` - Archive completed changes
            ```

            After (polished-notes.md):
            ```
            ### New

            - **Change archiving** - Archive completed changes with `lightspec archive`. Preserves change history and metadata.
            ```

            After (release-title.txt):
            ```
            v0.23.0 - Enhanced Change Management
            ```

            Write both files. No other output.

      - name: Skip polishing (Claude auth not configured)
        if: ${{ steps.auth-check.outputs.has_auth != 'true' }}
        run: |
          echo "Skipping AI polishing: configure CLAUDE_CODE_OAUTH_TOKEN or ANTHROPIC_API_KEY to enable this step."

      - name: Update release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ env.TAG_NAME }}"

          if [ -f "polished-notes.md" ] && [ -f "release-title.txt" ]; then
            TITLE=$(cat release-title.txt)
            gh release edit "$TAG" --title "$TITLE" --notes-file polished-notes.md
            echo "Updated: $TITLE"
          elif [ -f "polished-notes.md" ]; then
            gh release edit "$TAG" --notes-file polished-notes.md
            echo "Updated notes (title unchanged)"
          else
            echo "No changes generated, keeping original"
          fi
